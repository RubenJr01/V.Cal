<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>V.Cal — Phase 1</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 16px;
      }
      header {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      ul {
        padding-left: 1rem;
      }
      li {
        margin: 0.5rem 0;
      }
      form {
        display: grid;
        gap: 8px;
        max-width: 420px;
        margin: 12px 0;
      }
      input,
      textarea,
      button {
        padding: 6px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .muted {
        color: #666;
        font-size: 0.9rem;
      }
      .msg {
        min-height: 1.2em;
      }
      .msg.error {
        color: #b00020;
      }
      .msg.success {
        color: #0b7;
      }
    </style>
  </head>
  <body>
    <header>
      <button id="todayBtn">Today</button>
      <button id="prevBtn">&lt;</button>
      <button id="nextBtn">&gt;</button>
      <h3 id="dateLabel" style="margin-left: 8px"></h3>
    </header>

    <section>
      <h4>Add Event</h4>
      <form id="createForm">
        <input id="title" placeholder="Title" required />

        <!-- Split date + time for START -->
        <div class="row">
          <label
            >Start date <input id="startDate" type="date" required
          /></label>
          <label
            >Start time <input id="startTime" type="time" required
          /></label>
        </div>

        <!-- Split date + time for END -->
        <div class="row">
          <label>End date <input id="endDate" type="date" required /></label>
          <label>End time <input id="endTime" type="time" required /></label>
        </div>

        <label><input id="allDay" type="checkbox" /> All day</label>

        <textarea id="description" placeholder="Description"></textarea>

        <button id="createBtn" type="submit">Create</button>
        <div id="formMsg" class="msg muted"></div>
      </form>
    </section>

    <section>
      <h4>Events</h4>
      <ul id="eventList"></ul>
    </section>

    <script>
      // --- CSRF helper (Django) ---
      function getCookie(name) {
        const v = document.cookie.split(";").map((c) => c.trim());
        for (const c of v)
          if (c.startsWith(name + "="))
            return decodeURIComponent(c.split("=")[1]);
        return null;
      }
      const csrftoken = getCookie("csrftoken");

      const BASE = "/api";
      const listEl = document.getElementById("eventList");
      const dateLabel = document.getElementById("dateLabel");
      const msgEl = document.getElementById("formMsg");
      const btnEl = document.getElementById("createBtn");
      let currentDate = new Date();

      // Utilities
      function fmtDate(d) {
        return d.toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }
      function toISOFromLocal(dateStr, timeStr) {
        const local = new Date(`${dateStr}T${timeStr}`); // local time
        return local.toISOString();
      }
      function makeLocalDate(dateId, timeId) {
        const d = document.getElementById(dateId).value; // YYYY-MM-DD
        const t = document.getElementById(timeId).value; // HH:mm
        return new Date(`${d}T${t}`); // local
      }

      // Prefill date & time to now
      function prefillNow() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, "0");
        const d = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
          now.getDate()
        )}`;
        const tPlus1h = new Date(now.getTime() + 60 * 60 * 1000);
        const t1 = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        const t2 = `${pad(tPlus1h.getHours())}:${pad(tPlus1h.getMinutes())}`;
        document.getElementById("startDate").value = d;
        document.getElementById("endDate").value = d;
        document.getElementById("startTime").value = t1;
        document.getElementById("endTime").value = t2;
      }

      async function refresh() {
        dateLabel.textContent = fmtDate(currentDate);
        const res = await fetch(`${BASE}/events/`);
        const data = await res.json();
        listEl.innerHTML = "";
        data.forEach((e) => {
          const li = document.createElement("li");
          const start = new Date(e.start);
          const end = new Date(e.end);
          li.innerHTML = `<strong>${
            e.title
          }</strong> — ${start.toLocaleString()} → ${end.toLocaleTimeString()}
           <button data-id="${e.id}" class="del">Delete</button>`;
          listEl.appendChild(li);
        });
        document.querySelectorAll("button.del").forEach((btn) =>
          btn.addEventListener("click", async (ev) => {
            const id = ev.target.getAttribute("data-id");
            const delRes = await fetch(`${BASE}/events/${id}/`, {
              method: "DELETE",
              headers: {
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest",
              },
            });
            if (!delRes.ok) {
              alert("Failed to delete. Please try again.");
              return;
            }
            refresh();
          })
        );
      }

      document
        .getElementById("createForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          msgEl.className = "msg muted";
          msgEl.textContent = "";
          btnEl.disabled = true;

          // Client-side validation: end must be after start
          const startLocal = makeLocalDate("startDate", "startTime");
          const endLocal = makeLocalDate("endDate", "endTime");
          if (!(startLocal < endLocal)) {
            msgEl.className = "msg error";
            msgEl.textContent = "End time must be after start time.";
            btnEl.disabled = false;
            return;
          }

          const payload = {
            title: document.getElementById("title").value,
            start: toISOFromLocal(
              document.getElementById("startDate").value,
              document.getElementById("startTime").value
            ),
            end: toISOFromLocal(
              document.getElementById("endDate").value,
              document.getElementById("endTime").value
            ),
            all_day: document.getElementById("allDay").checked,
            description: document.getElementById("description").value,
          };

          try {
            const res = await fetch(`${BASE}/events/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest",
              },
              body: JSON.stringify(payload),
            });

            if (!res.ok) {
              // Parse DRF error: {'field':['msg']} | {'non_field_errors':['msg']}
              let errText = "Error creating event.";
              try {
                const data = await res.json();
                errText = Object.entries(data)
                  .map(
                    ([k, v]) => `${k}: ${Array.isArray(v) ? v.join(", ") : v}`
                  )
                  .join(" | ");
              } catch {
                errText = (await res.text()) || errText;
              }
              msgEl.className = "msg error";
              msgEl.textContent = errText;
              btnEl.disabled = false;
              return;
            }

            // Success state
            e.target.reset();
            prefillNow();
            await refresh();
            msgEl.className = "msg success";
            msgEl.textContent = "Event created.";
            setTimeout(() => {
              msgEl.textContent = "";
              msgEl.className = "msg muted";
            }, 2000);
          } catch (err) {
            msgEl.className = "msg error";
            msgEl.textContent = "Network error. Please try again.";
          } finally {
            btnEl.disabled = false;
          }
        });

      document.getElementById("todayBtn").onclick = () => {
        currentDate = new Date();
        refresh();
      };
      document.getElementById("prevBtn").onclick = () => {
        currentDate.setDate(currentDate.getDate() - 1);
        refresh();
      };
      document.getElementById("nextBtn").onclick = () => {
        currentDate.setDate(currentDate.getDate() + 1);
        refresh();
      };

      prefillNow();
      refresh();
    </script>
  </body>
</html>
